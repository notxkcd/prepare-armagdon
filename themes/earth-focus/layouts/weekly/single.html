{{ define "main" }}
<article>
    <header>
        <h1>{{ .Title }}</h1>
        <p class="meta">Week ending: {{ .Date.Format "January 2, 2006" }}</p>
    </header>

    {{/* 1. Calculate Date Range (Mon-Sun of this week) */}}
    {{ $weekEnd := .Date }}
    {{ $weekStart := $weekEnd.AddDate 0 0 -6 }}
    
    {{/* 2. Fetch Logs in Range */}}
    {{ $allLogs := where .Site.RegularPages "Section" "daily" }}
    {{ $weeklyLogs := slice }}
    {{ range $allLogs }}
        {{ if and (ge .Date $weekStart) (le .Date $weekEnd) }}
            {{ $weeklyLogs = $weeklyLogs | append . }}
        {{ end }}
    {{ end }}

    {{/* 3. Aggregate Data */}}
    {{ $totalWork := 0.0 }}
    {{ $totalLearn := 0.0 }}
    {{ $totalPhys := 0.0 }}

    {{ range $weeklyLogs }}
        {{ $totalWork = add $totalWork (.Params.focus_hours | default 0) }}
        {{ $totalLearn = add $totalLearn (.Params.learning_hours | default 0) }}
        {{ $totalPhys = add $totalPhys (.Params.physical_hours | default 0) }}
    {{ end }}

    {{ $grandTotal := add (add $totalWork $totalLearn) $totalPhys }}
    {{ if eq $grandTotal 0.0 }} {{ $grandTotal = 1.0 }} {{ end }} {{/* Prevent div by zero */}}

    <section class="dashboard-grid">
        <div class="stat-card">
            <span class="stat-label">Deep Work</span>
            <span class="stat-value">{{ $totalWork }}h</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Learning</span>
            <span class="stat-value">{{ $totalLearn }}h</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Physical</span>
            <span class="stat-value">{{ $totalPhys }}h</span>
        </div>
    </section>

    <section>
        <h3 style="margin-top: 3rem; text-align: center;">Time Distribution</h3>
        <table class="charts-css column show-labels data-spacing-20" id="weekly-chart">
            <caption> Time Allocation </caption>
            <tbody>
                <tr>
                    <th scope="row"> Work </th>
                    <td style="--size: calc( {{ $totalWork }} / {{ $grandTotal }} ); --color: #3d4a26;"> 
                        <span class="data"> {{ $totalWork }}h </span> 
                    </td>
                </tr>
                <tr>
                    <th scope="row"> Learn </th>
                    <td style="--size: calc( {{ $totalLearn }} / {{ $grandTotal }} ); --color: #a68b5a;"> 
                        <span class="data"> {{ $totalLearn }}h </span> 
                    </td>
                </tr>
                <tr>
                    <th scope="row"> Body </th>
                    <td style="--size: calc( {{ $totalPhys }} / {{ $grandTotal }} ); --color: #8c5e44;"> 
                        <span class="data"> {{ $totalPhys }}h </span> 
                    </td>
                </tr>
            </tbody>
        </table>
    </section>

    <section>
        <h3 style="margin-top: 3rem; text-align: center;">Daily Rhythm</h3>
        <p style="text-align: center; font-size: 0.9rem; color: #777; margin-bottom: 2rem;">Total hours (Work + Learn + Body) vs daily targets</p>
        
        <table class="charts-css column show-labels data-spacing-5 stacked" id="daily-rhythm-chart">
            <caption> Daily Total Output vs Target </caption>
            <tbody>
                {{ range $weeklyLogs.Reverse }}
                    {{ $dayTotal := add (add (.Params.focus_hours | default 0) (.Params.learning_hours | default 0)) (.Params.physical_hours | default 0) }}
                    {{ $dayTarget := add (add (.Params.focus_target | default 8) (.Params.learning_target | default 4)) (.Params.physical_target | default 2) }}
                    {{ $missed := sub $dayTarget $dayTotal }}
                    {{ if lt $missed 0.0 }} {{ $missed = 0.0 }} {{ end }}
                    
                    {{/* Scale based on a 14-hour max to fit target + potential overage */}}
                    <tr>
                        <th scope="row"> {{ .Date.Format "Mon" }} </th>
                        <td style="--size: calc( {{ $dayTotal }} / 14 );"> 
                            <span class="data"> {{ $dayTotal }}h </span> 
                        </td>
                        {{ if gt $missed 0.0 }}
                        <td class="target-ghost" style="--size: calc( {{ $missed }} / 14 );"></td>
                        {{ end }}
                    </tr>
                {{ end }}
            </tbody>
        </table>
    </section>

    <section>
        <h3 style="margin-top: 3rem; text-align: center;">Ritual Adherence</h3>
        <p style="text-align: center; font-size: 0.9rem; color: #777; margin-bottom: 2rem;">Consistency of core habits (out of 7 days)</p>
        
        {{/* Count occurrences of [x] for specific strings */}}
        {{ $habits := slice "Fajr" "Dhuhr" "Asr" "Maghrib" "Isha" "Morning Meditation" "Exercise / Ruck" "Programming Practice" }}
        
        <table class="charts-css horizontal show-labels data-spacing-10" id="habit-chart">
            <caption> Habit Consistency </caption>
            <tbody>
                {{ range $habits }}
                    {{ $habit := . }}
                    {{ $count := 0 }}
                    {{ range $weeklyLogs }}
                        {{ if in .RawContent (printf "[x] %s" $habit) }}
                            {{ $count = add $count 1 }}
                        {{ end }}
                    {{ end }}
                    <tr>
                        <th scope="row"> {{ $habit }} </th>
                        <td style="--size: calc( {{ $count }} / 7 );"> 
                            <span class="data"> {{ $count }}/7 </span> 
                        </td>
                    </tr>
                {{ end }}
            </tbody>
        </table>
    </section>

    <section>
        <h3 style="margin-top: 3rem; text-align: center;">Daily Peak Hours (Pomodoros)</h3>
        <p class="meta" style="text-align: center;">When you are most active during the day.</p>
        
        {{/* 1. Extract and count hours from all weekly logs */}}
        {{ $hourCounts := dict }}
        {{ range seq 0 23 }}
            {{ $hourCounts = merge $hourCounts (dict (string .) 0) }}
        {{ end }}

        {{ range $weeklyLogs }}
            {{ $timestamps := findRE `\[([0-9]{2}):[0-9]{2}\]` .Content }}
            {{ range $timestamps }}
                {{ $hour := index (findRE `[0-9]{2}` .) 0 }}
                {{ $currentCount := index $hourCounts $hour }}
                {{ $hourCounts = merge $hourCounts (dict $hour (add $currentCount 1)) }}
            {{ end }}
        {{ end }}

        {{/* 2. Find the max count for scaling */}}
        {{ $maxCount := 1 }}
        {{ range $hour, $count := $hourCounts }}
            {{ if gt $count $maxCount }} {{ $maxCount = $count }} {{ end }}
        {{ end }}

        <table class="charts-css column show-labels data-spacing-2" id="peak-chart">
            <caption> Pomodoro completions by hour </caption>
            <tbody>
                {{ range $h := seq 4 23 }} {{/* Focused on 4AM to Midnight */}}
                    {{ $hourStr := printf "%02d" $h }}
                    {{ $count := index $hourCounts $hourStr }}
                    <tr>
                        <th scope="row"> {{ $hourStr }} </th>
                        <td style="--size: calc( {{ $count }} / {{ $maxCount }} ); --color: var(--accent-color);">
                            {{ if gt $count 0 }}<span class="data">{{ $count }}</span>{{ end }}
                        </td>
                    </tr>
                {{ end }}
            </tbody>
        </table>
    </section>

    <hr style="margin: 3rem 0;">

    <section class="content">
        <h2>Reflections</h2>
        {{ .Content }}
    </section>
</article>

<style>
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: #f4f1ea;
    padding: 1rem;
    border-radius: 4px;
    text-align: center;
    border: 1px solid #e6e2da;
}

.stat-label {
    display: block;
    font-size: 0.8rem;
    text-transform: uppercase;
    color: #777;
    letter-spacing: 0.05em;
}

.stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--accent-color);
}

#weekly-chart {
    height: 250px;
    max-width: 400px;
    margin: 0 auto;
}

#weekly-chart td {
    background-color: var(--color);
}

#weekly-chart .data {
    font-weight: bold;
    margin-top: -20px; /* Pull text up */
}
</style>
{{ end }}
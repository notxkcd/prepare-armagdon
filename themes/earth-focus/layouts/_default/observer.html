{{ define "main" }}
<article>
    <header>
        <h1>{{ .Title }}</h1>
        <p class="meta">Factual status of the system. Updated daily.</p>
    </header>

    <section class="observer-summary">
        <h2>Weekly Consistency</h2>
        <div class="heatmap">
            {{ $dailyLogs := (where .Site.RegularPages "Section" "daily") }}
            {{/* Show last 7 days */}}
            {{ range first 7 $dailyLogs }}
                <div class="day-box {{ if eq .Params.status "Complete" }}done{{ else if eq .Params.status "Partial" }}partial{{ else }}empty{{ end }}" 
                     data-tooltip="{{ .Date.Format "Monday, Jan 2" }}: {{ .Params.status | default "No Status" }}">
                </div>
            {{ else }}
                <p>No logs found yet.</p>
            {{ end }}
        </div>
        <p style="font-size: 0.9rem; margin-top: 1rem;">
            <em>Displaying status for the last 7 logged days.</em>
        </p>

        <h3 style="margin-top: 2rem;">Workload Trend (Deep Work)</h3>
        <table class="charts-css bar show-labels data-spacing-5" id="work-chart">
            <caption> Weekly Focus Hours </caption>
            <tbody>
                {{/* Reverse the logs so they read left-to-right (oldest to newest) */}}
                {{ range (first 7 $dailyLogs).Reverse }}
                <tr>
                    <th scope="row"> {{ .Date.Format "Mon" }} </th>
                    {{/* Calculate size relative to an 8-hour workday max */}}
                    {{ $val := .Params.focus_hours | default 0 }}
                    <td style="--size: calc( {{ $val }} / 8 );"> 
                        <span class="data"> {{ $val }}h </span> 
                    </td>
                </tr>
                {{ end }}
            </tbody>
        </table>
    </section>

    <hr>

    <section>
        <h2>Recent Logs</h2>
        {{ range first 5 $dailyLogs }}
        <div class="list-item summary-card">
            <h3><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
            
            {{/* Logic to parse completed vs unfinished */}}
            {{ $content := .RawContent }}
            {{ $lines := split $content "\n" }}
            {{ $completed := slice }}
            {{ $unfinishedCount := 0 }}
            
            {{ range $lines }}
                {{ if findRE "^- \\[x\\]" . }}
                    {{/* Extract task name, remove '- [x] ' */}}
                    {{ $cleanName := replaceRE "^- \\[x\\] " "" . }}
                    {{/* Filter for key rituals to keep it brief */}}
                    {{ if or (in $cleanName "Fajr") (in $cleanName "Dhuhr") (in $cleanName "Asr") (in $cleanName "Maghrib") (in $cleanName "Isha") (in $cleanName "Deep Work") (in $cleanName "Exercise") }}
                        {{ $completed = $completed | append $cleanName }}
                    {{ end }}
                {{ else if findRE "^- \\[ \\]" . }}
                    {{ $unfinishedCount = add $unfinishedCount 1 }}
                {{ end }}
            {{ end }}

            <div class="log-summary">
                <div class="completed-preview">
                    <strong>Completed Key Rituals:</strong>
                    {{ if $completed }}
                        <span class="ritual-tags">
                            {{ delimit $completed " â€¢ " }}
                        </span>
                    {{ else }}
                        <span style="color: #999;">None recorded</span>
                    {{ end }}
                </div>
                <div class="unfinished-stat">
                    Unfinished Tasks: <span class="count-badge {{ if eq $unfinishedCount 0 }}zero{{ end }}">{{ $unfinishedCount }}</span>
                </div>
            </div>
        </div>
        {{ end }}
    </section>

    <section class="rules">
        <h3>Observer Rules</h3>
        <ul style="font-size: 0.9rem; color: #555;">
            <li>Purpose: Visibility without micromanagement.</li>
            <li>Check-in frequency: Sunday mornings recommended.</li>
            <li>If a day is missed: Assume system friction, not intent.</li>
        </ul>
    </section>
</article>
{{ end }}

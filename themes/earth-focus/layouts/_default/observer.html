{{ define "main" }}
<article>
    <header>
        <h1>{{ .Title }}</h1>
        <p class="meta">Factual status of the system. Updated daily.</p>
    </header>

    <section class="observer-summary">
        <h2>Weekly Consistency</h2>
        <div class="heatmap">
            {{ $dailyLogs := (where .Site.RegularPages "Section" "daily") }}
            {{/* Show last 7 days */}}
            {{ range first 7 $dailyLogs }}
                <div class="day-box {{ if eq .Params.status "Complete" }}done{{ else if eq .Params.status "Partial" }}partial{{ else }}empty{{ end }}" 
                     data-tooltip="{{ .Date.Format "Monday, Jan 2" }}: {{ .Params.status | default "No Status" }}">
                </div>
            {{ else }}
                <p>No logs found yet.</p>
            {{ end }}
        </div>
        <p style="font-size: 0.9rem; margin-top: 1rem;">
            <em>Displaying status for the last 7 logged days.</em>
        </p>

        <h3 style="margin-top: 2rem;">Workload Trend (Deep Work)</h3>
        <table class="charts-css bar show-labels data-spacing-5" id="work-chart">
            <caption> Weekly Focus Hours </caption>
            <tbody>
                {{/* Reverse the logs so they read left-to-right (oldest to newest) */}}
                {{ range (first 7 $dailyLogs).Reverse }}
                <tr>
                    <th scope="row"> {{ .Date.Format "Mon" }} </th>
                    {{/* Calculate size relative to an 8-hour workday max for visual consistency */}}
                    {{ $val := .Params.focus_hours | default 0 }}
                    {{ $target := .Params.focus_target | default 8 }}
                    {{ $percent := mul (div $val $target) 100 }}
                    
                    {{/* Determine color based on target completion percentage */}}
                    {{ $color := "#8c5e44" }} {{/* Fail/Low */}}
                    {{ if ge $percent 100 }}
                        {{ $color = "#556b2f" }} {{/* Success */}}
                    {{ else if ge $percent 50 }}
                        {{ $color = "#a68b5a" }} {{/* Partial */}}
                    {{ end }}

                    <td style="--size: calc( {{ $val }} / 8 ); background-color: {{ $color }};"> 
                        <span class="data"> {{ $val }}h </span> 
                    </td>
                </tr>
                {{ end }}
            </tbody>
        </table>
    </section>

    <hr>

    <section>
        <h2>Recent Logs</h2>
        {{ range first 5 $dailyLogs }}
        <div class="list-item summary-card daily-card status-{{ .Params.status | lower }}">
            <header class="card-header">
                <h3><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
                <span class="status-pill {{ .Params.status | lower }}">{{ .Params.status | default "Pending" }}</span>
            </header>

            {{/* Metrics Row with Progress Bars */}}
            <div class="metrics-dashboard">
                <div class="metric-group">
                    <div class="metric-label">
                        <span><i class="fa-solid fa-brain"></i> Focus</span>
                        <strong>{{ .Params.focus_hours | default 0 }}h <span class="target-muted">/ {{ .Params.focus_target | default 8 }}h</span></strong>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill work" style="width: {{ mul (div (.Params.focus_hours | default 0) (.Params.focus_target | default 8)) 100 }}%"></div>
                    </div>
                </div>
                
                <div class="metric-group">
                    <div class="metric-label">
                        <span><i class="fa-solid fa-book"></i> Learn</span>
                        <strong>{{ .Params.learning_hours | default 0 }}h <span class="target-muted">/ {{ .Params.learning_target | default 4 }}h</span></strong>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill learn" style="width: {{ mul (div (.Params.learning_hours | default 0) (.Params.learning_target | default 4)) 100 }}%"></div>
                    </div>
                </div>

                <div class="metric-group">
                    <div class="metric-label">
                        <span><i class="fa-solid fa-person-running"></i> Body</span>
                        <strong>{{ .Params.physical_hours | default 0 }}h <span class="target-muted">/ {{ .Params.physical_target | default 2 }}h</span></strong>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill body" style="width: {{ mul (div (.Params.physical_hours | default 0) (.Params.physical_target | default 2)) 100 }}%"></div>
                    </div>
                </div>
            </div>
            
            {{/* Content Parsing Logic */}}
            {{ $content := .RawContent }}
            {{ $lines := split $content "\n" }}
            {{ $completed := slice }}
            {{ $unfinishedCount := 0 }}
            
            {{ range $lines }}
                {{ if in . "- [x]" }}
                    {{ if in . "Fajr" }} {{ $completed = $completed | append "Fajr" }} {{ end }}
                    {{ if in . "Dhuhr" }} {{ $completed = $completed | append "Dhuhr" }} {{ end }}
                    {{ if in . "Asr" }} {{ $completed = $completed | append "Asr" }} {{ end }}
                    {{ if in . "Maghrib" }} {{ $completed = $completed | append "Maghrib" }} {{ end }}
                    {{ if in . "Isha" }} {{ $completed = $completed | append "Isha" }} {{ end }}
                    {{ if in . "Deep Work" }} {{ $completed = $completed | append "Deep Work" }} {{ end }}
                    {{ if in . "Exercise" }} {{ $completed = $completed | append "Exercise" }} {{ end }}
                {{ else if in . "- [ ]" }}
                    {{ $unfinishedCount = add $unfinishedCount 1 }}
                {{ end }}
            {{ end }}

            <div class="log-summary" style="margin-top: 1.5rem;">
                <div class="completed-preview">
                    {{ if $completed }}
                        <span class="ritual-tags">
                            {{ delimit $completed " â€¢ " }}
                        </span>
                    {{ end }}
                </div>
                <div class="unfinished-stat">
                    {{ if gt $unfinishedCount 0 }}
                    <span class="count-badge">{{ $unfinishedCount }} tasks remaining</span>
                    {{ else }}
                    <span class="count-badge zero">All tasks cleared</span>
                    {{ end }}
                </div>
            </div>
        </div>
        {{ end }}
    </section>

    <section class="rules">
        <h3>Observer Rules</h3>
        <ul style="font-size: 0.9rem; color: #555;">
            <li>Purpose: Visibility without micromanagement.</li>
            <li>Check-in frequency: Sunday mornings recommended.</li>
            <li>If a day is missed: Assume system friction, not intent.</li>
        </ul>
    </section>
</article>
{{ end }}